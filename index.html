<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RAG Voice QA System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #eef2ff, #fafafa);
    }
    .card {
      border-radius: 1rem;
      box-shadow: 0 8px 24px rgba(0,0,0,0.05);
    }
    .section-title {
      font-weight: 600;
      color: #374151;
    }
  </style>
</head>
<body>
  <div class="container py-5">
    <div class="card p-4">
      <h2 class="mb-3 text-primary">üéôÔ∏è RAG Voice QA System</h2>
      <p class="text-muted">Upload documents, then ask via audio and get instant voice answers.</p>

      <!-- Document Upload -->
      <div class="mb-4">
        <h5 class="section-title">Upload Document</h5>
        <input type="file" id="docInput" class="form-control" accept=".pdf,.docx,.pptx,.txt">
        <button class="btn btn-primary mt-2" onclick="uploadDocument()">Upload</button>
        <div id="uploadStatus" class="mt-2 text-success"></div>
      </div>

      <!-- Document Stats -->
      <div class="mb-4">
        <h5 class="section-title">Documents Status</h5>
        <div id="docStats" class="text-muted">No data yet.</div>
      </div>

      <!-- Ask Audio -->
      <div class="mb-4">
        <h5 class="section-title">Ask a Question (Upload Audio)</h5>
        <input type="file" id="audioInput" class="form-control" accept=".wav,.mp3,.m4a,.flac">
        <button class="btn btn-success mt-2" onclick="askAudio()">Ask</button>
        <div id="askStatus" class="mt-2 text-info"></div>
      </div>

      <!-- Response -->
      <div class="mb-3" id="responseBox" style="display:none;">
        <h5 class="section-title">Answer</h5>
        <audio id="audioPlayer" controls autoplay class="w-100"></audio>
        <p class="mt-2"><strong>Transcript:</strong> <span id="transcriptText"></span></p>
        <p class="text-muted"><strong>Query:</strong> <span id="queryText"></span></p>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_BASE = "http://localhost:8000"; // change if needed

    async function uploadDocument() {
      const fileInput = document.getElementById("docInput");
      if (!fileInput.files.length) return alert("Please select a document.");
      const file = fileInput.files[0];

      const formData = new FormData();
      formData.append("file", file);

      document.getElementById("uploadStatus").innerText = "Uploading...";

      try {
        const res = await fetch(`${API_BASE}/upload_doc`, {
          method: "POST",
          body: formData
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || "Upload failed");

        document.getElementById("uploadStatus").innerText = data.message;

        // Refresh stats
        const statsRes = await fetch(`${API_BASE}/documents/status`);
        const stats = await statsRes.json();
        document.getElementById("docStats").innerText =
          `Total Chunks: ${stats.total_chunks}, Index Size: ${stats.index_size}`;
      } catch (err) {
        document.getElementById("uploadStatus").innerText = err.message;
      }
    }

    async function askAudio() {
      const fileInput = document.getElementById("audioInput");
      if (!fileInput.files.length) return alert("Please select an audio file.");
      const file = fileInput.files[0];

      const formData = new FormData();
      formData.append("file", file);

      document.getElementById("askStatus").innerText = "Processing...";

      try {
        const res = await fetch(`${API_BASE}/ask_audio`, {
          method: "POST",
          body: formData
        });
        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.detail || "Request failed");
        }

        // Extract transcript & query from headers
        const transcript = res.headers.get("Transcript-Text") || "";
        const query = res.headers.get("X-Original-Query") || "";

        const audioBlob = await res.blob();
        const audioUrl = URL.createObjectURL(audioBlob);

        // Show response
        document.getElementById("responseBox").style.display = "block";
        document.getElementById("audioPlayer").src = audioUrl;
        document.getElementById("transcriptText").innerText = transcript;
        document.getElementById("queryText").innerText = query;

        document.getElementById("askStatus").innerText = "Done!";
      } catch (err) {
        document.getElementById("askStatus").innerText = err.message;
      }
    }
  </script>
</body>
</html>
